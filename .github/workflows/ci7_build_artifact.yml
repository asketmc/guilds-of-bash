# FILE: .github/workflows/ci7_build_artifact.yml
name: CI module - Build standalone artifact

on:
  workflow_call:
    outputs:
      version:
        description: Derived build version (tag name or build-<run>-<sha7>)
        value: ${{ jobs.build-standalone-jar.outputs.version }}
      short_sha:
        description: 7-char commit sha
        value: ${{ jobs.build-standalone-jar.outputs.short_sha }}
      artifact_jar_name:
        description: Upload-artifact name for the standalone jar bundle
        value: ${{ jobs.build-standalone-jar.outputs.artifact_jar_name }}
      artifact_dokka_name:
        description: Upload-artifact name for the Dokka HTML tarball
        value: ${{ jobs.build-standalone-jar.outputs.artifact_dokka_name }}

permissions:
  contents: read
  actions: write

concurrency:
  group: ci7_build_artifact-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-standalone-jar:
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.ver.outputs.version }}
      short_sha: ${{ steps.ver.outputs.short_sha }}
      artifact_jar_name: ${{ steps.meta.outputs.artifact_jar_name }}
      artifact_dokka_name: ${{ steps.meta.outputs.artifact_dokka_name }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Make gradlew executable
        shell: bash
        run: test -x ./gradlew || chmod +x ./gradlew

      - name: Derive build version
        id: ver
        shell: bash
        run: |
          set -euo pipefail

          sha="${GITHUB_SHA:-}"
          short_sha="${sha:0:7}"

          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            version="${GITHUB_REF_NAME}"
          else
            version="build-${GITHUB_RUN_NUMBER}-${short_sha}"
          fi

          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${short_sha}" >> "$GITHUB_OUTPUT"

      - name: Derive artifact names (outputs)
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          v="${{ steps.ver.outputs.version }}"

          echo "artifact_jar_name=adapter-console-standalone-jar-${v}" >> "$GITHUB_OUTPUT"
          echo "artifact_dokka_name=dokka-html-${v}" >> "$GITHUB_OUTPUT"

      - name: Build standalone fat jar (captured)
        shell: bash
        run: |
          set -euo pipefail

          log="gradle_shadowjar.log"

          ./gradlew \
            --console=plain \
            --warning-mode=all \
            -Pversion="${{ steps.ver.outputs.version }}" \
            :adapter-console:shadowJar \
            >"${log}" 2>&1 || {
              echo "FAIL: ShadowJar build failed."
              echo "Failure block (max 25 lines):"
              awk 'BEGIN{p=0} /^FAILURE: /{p=1} p{print} /^BUILD FAILED/{exit}' "${log}" | head -n 25 || true
              echo "Tail (last 40 lines):"
              tail -n 40 "${log}" || true
              exit 1
            }

      - name: Build Dokka multi-module HTML (captured)
        shell: bash
        run: |
          set -euo pipefail

          log="gradle_dokka.log"

          ./gradlew \
            --console=plain \
            --warning-mode=all \
            -Pversion="${{ steps.ver.outputs.version }}" \
            dokkaHtmlMultiModule \
            >"${log}" 2>&1 || {
              echo "FAIL: Dokka build failed."
              echo "Failure block (max 25 lines):"
              awk 'BEGIN{p=0} /^FAILURE: /{p=1} p{print} /^BUILD FAILED/{exit}' "${log}" | head -n 25 || true
              echo "Tail (last 40 lines):"
              tail -n 40 "${log}" || true
              exit 1
            }

      - name: Normalize artifact name + checksums + build info
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p dist

          shopt -s nullglob
          jars=(adapter-console/build/libs/*-all.jar)
          shopt -u nullglob

          if (( ${#jars[@]} != 1 )); then
            echo "FAIL: Expected exactly 1 '*-all.jar' but found ${#jars[@]}."
            printf '%s\n' "${jars[@]:-<none>}"
            exit 1
          fi

          src="${jars[0]}"
          out="adapter-console-cli-${{ steps.ver.outputs.version }}.jar"

          cp -f "$src" "dist/$out"

          (cd dist && sha256sum "$out" > "${out}.sha256")
          (cd dist && sha256sum "$out" > "checksums-${{ steps.ver.outputs.version }}.sha256")

          cat > "dist/build-info-${{ steps.ver.outputs.version }}.txt" <<EOF
          version: ${{ steps.ver.outputs.version }}
          commit: ${GITHUB_SHA}
          ref: ${GITHUB_REF}
          workflow: ${GITHUB_WORKFLOW}
          run_id: ${GITHUB_RUN_ID}
          run_number: ${GITHUB_RUN_NUMBER}
          runner: ${RUNNER_OS}
          EOF

          cp -f gradle_shadowjar.log "dist/gradle_shadowjar.log"

      - name: Collect Dokka HTML artifact
        shell: bash
        run: |
          set -euo pipefail

          src_dir="build/reports/dokka/html"
          if [[ ! -d "$src_dir" ]]; then
            echo "FAIL: Dokka output directory not found: $src_dir"
            exit 1
          fi

          mkdir -p dist/dokka
          cp -R "$src_dir"/* dist/dokka/

          (cd dist && tar -czf "dokka-html-${{ steps.ver.outputs.version }}.tar.gz" dokka)
          rm -rf dist/dokka

      - name: Upload standalone jar artifact (normalized)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_jar_name }}
          path: dist/*
          if-no-files-found: error
          retention-days: 14

      - name: Upload Dokka HTML (tar.gz)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_dokka_name }}
          path: |
            dist/dokka-html-${{ steps.ver.outputs.version }}.tar.gz
            gradle_dokka.log
          if-no-files-found: error
          retention-days: 14

      - name: Write job summary
        shell: bash
        run: |
          set -euo pipefail

          {
            echo "### Build artifacts"
            echo "- version: \`${{ steps.ver.outputs.version }}\`"
            echo "- commit: \`${GITHUB_SHA}\`"
            echo "- jar: \`adapter-console-cli-${{ steps.ver.outputs.version }}.jar\`"
            echo "- checksums: \`checksums-${{ steps.ver.outputs.version }}.sha256\`"
            echo "- artifact (jar bundle): \`${{ steps.meta.outputs.artifact_jar_name }}\`"
            echo "- artifact (dokka): \`${{ steps.meta.outputs.artifact_dokka_name }}\`"
            echo ""
            echo "### Verification"
            echo "\`\`\`bash"
            echo "sha256sum -c adapter-console-cli-${{ steps.ver.outputs.version }}.jar.sha256"
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload ShadowJar gradle log (on failure)
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: logs-shadowjar-${{ steps.ver.outputs.short_sha }}
          path: gradle_shadowjar.log
          if-no-files-found: warn
          retention-days: 14

      - name: Upload Dokka gradle log (on failure)
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: logs-dokka-${{ steps.ver.outputs.short_sha }}
          path: gradle_dokka.log
          if-no-files-found: warn
          retention-days: 14
