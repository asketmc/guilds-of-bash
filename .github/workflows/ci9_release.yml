# FILE: .github/workflows/ci9_release.yml
name: CI module - Release (GitHub)

on:
  workflow_call:
    inputs:
      artifact_name:
        type: string
        required: true
      version:
        type: string
        required: true
      tag_prefix:
        type: string
        required: false
        default: build
      prerelease:
        type: boolean
        required: false
        default: false

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: dist

      - name: Create or update GitHub Release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          version="${{ inputs.version }}"

          jar="dist/adapter-console-cli-${version}.jar"
          if [[ ! -f "${jar}" ]]; then
            echo "ERROR: expected jar not found: ${jar}" >&2
            echo "dist/ contents:" >&2
            ls -la dist >&2 || true
            exit 1
          fi

          sha_full="${GITHUB_SHA}"
          sha_short="${sha_full:0:7}"

          sha256_file="${jar}.sha256"
          sha256sum "${jar}" > "${sha256_file}"

          tag="${{ inputs.tag_prefix }}-${{ github.run_number }}"
          title="Release ${tag} (v${version})"

          run_url="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          cat > release_notes.md <<EOF
  - version: ${version}
  - commit: ${sha_full} (${sha_short})
  - artifacts: ${jar##*/}, ${sha256_file##*/}
  - ci_run: ${run_url}
  EOF
  
  prerelease_flag=""
  if [[ "${{ inputs.prerelease }}" == "true" ]]; then
  prerelease_flag="--prerelease"
  fi
  
  if gh release view "${tag}" >/dev/null 2>&1; then
  gh release edit "${tag}" --title "${title}" --notes-file release_notes.md
  gh release upload "${tag}" "${jar}" "${sha256_file}" --clobber
  else
  gh release create "${tag}" "${jar}" "${sha256_file}" \
  --title "${title}" \
  --notes-file release_notes.md \
  --target "${sha_full}" \
  ${prerelease_flag}
  fi
